{% extends "base.html" %}

{% block title %}Daily Entry - Daily Ledger{% endblock %}

{% block content %}
{% set edit_mode = edit_entry is defined and edit_entry %}
{% set credited_value = edit_entry.credited if edit_mode else '' %}
{% set debited_value = edit_entry.debited if edit_mode else '' %}
<div class="row">
    <div class="col-md-12">
        <!-- Daily Entry Form -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h4>{% if edit_mode %}Edit Daily Entry{% else %}Daily Ledger Entry{% endif %}</h4>

                {% if error %}
                <div class="alert alert-warning" id="errorAlert">
                    {{ error }}
                </div>
                {% endif %}

                <form method="POST" class="daily-entry-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    {% if edit_mode %}
                    <input type="hidden" name="edit_entry_id" value="{{ edit_entry._id }}">
                    {% endif %}

                    {% if edit_mode %}
                    <div class="row g-3 mb-3">
                        <div class="col-12 col-lg-4">
                            <label class="form-label small text-muted">Bank</label>
                            <input type="text" class="form-control py-3 bg-light" value="{{ edit_entry.bank_name }}" readonly>
                        </div>
                        <div class="col-12 col-lg-4">
                            <label class="form-label small text-muted">Available Before Entry</label>
                            <input type="text" id="availableBalance" class="form-control py-3 bg-light" value="{{ edit_entry.opening_balance }}" readonly>
                        </div>
                        <div class="col-12 col-lg-4">
                            <label class="form-label small text-muted">Date</label>
                            <div class="input-group date-input-group">
                                <span class="input-group-text bg-white border-end-0" aria-hidden="true">
                                    <i class="bi bi-calendar4"></i>
                                </span>
                                <input type="date" name="entry_date" class="form-control py-3 border-start-0" value="{{ edit_entry.date }}"
                                    min="{{ today }}" max="{{ today }}" readonly required>
                            </div>
                        </div>
                    </div>

                    <div class="row g-2 g-lg-3 mb-3 entry-amount-row">
                        <div class="col-6 col-lg-4 entry-amount-col">
                            <label class="form-label small text-muted">Credited</label>
                            <input type="number" name="credited" class="form-control py-3" placeholder="0" min="0" value="{{ credited_value }}"
                                step="0.01">
                        </div>
                        <div class="col-6 col-lg-4 entry-amount-col">
                            <label class="form-label small text-muted">Debited</label>
                            <input type="number" name="debited" class="form-control py-3" placeholder="0" min="0" value="{{ debited_value }}"
                                step="0.01">
                        </div>
                    </div>
                    {% else %}
                    <div class="row g-3 mb-3">
                        <div class="col-12 col-lg-4">
                            <label class="form-label small text-muted">Select Bank</label>
                            <div class="dropdown w-100">
                                {% set ns = namespace(bank_name='-- Select Bank --') %}
                                {% for bank in banks %}
                                {% if selected_bank and bank._id|string == selected_bank %}
                                {% set ns.bank_name = bank.name %}
                                {% endif %}
                                {% endfor %}
                                <button
                                    class="btn btn-outline-secondary w-100 text-start d-flex justify-content-between align-items-center py-3 custom-select-btn"
                                    type="button" id="bankDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false">
                                    <span>{{ ns.bank_name }}</span>
                                    <span class="dropdown-arrow">&#9662;</span>
                                </button>
                                <input type="hidden" name="bank_id" id="bankSelect" value="{{ selected_bank or '' }}"
                                    required>
                                <ul class="dropdown-menu w-100 shadow-sm custom-dropdown-menu"
                                    aria-labelledby="bankDropdownBtn">
                                    {% for bank in banks %}
                                    <li>
                                        <a class="dropdown-item py-2" href="#"
                                            onclick="selectBank('{{ bank._id }}', '{{ bank.name }}'); return false;">
                                            {{ bank.name }}
                                        </a>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>

                        <div class="col-12 col-lg-4">
                            <label class="form-label small text-muted">Available Balance</label>
                            <input type="text" id="availableBalance" class="form-control py-3 bg-light" value="0" readonly>
                        </div>

                        <div class="col-12 col-lg-4">
                            <label class="form-label small text-muted">Date</label>
                            <div class="input-group date-input-group">
                                <span class="input-group-text bg-white border-end-0" aria-hidden="true">
                                    <i class="bi bi-calendar4"></i>
                                </span>
                                <input type="date" name="entry_date" class="form-control py-3 border-start-0" value="{{ today }}"
                                    min="{{ today }}" max="{{ today }}" readonly required>
                            </div>
                        </div>
                    </div>

                    <div class="row g-2 g-lg-3 mb-3 entry-amount-row">
                        <div class="col-6 col-lg-4 entry-amount-col">
                            <label class="form-label small text-muted">Credited</label>
                            <input type="number" name="credited" class="form-control py-3" placeholder="0" min="0"
                                step="0.01">
                        </div>
                        <div class="col-6 col-lg-4 entry-amount-col">
                            <label class="form-label small text-muted">Debited</label>
                            <input type="number" name="debited" class="form-control py-3" placeholder="0" min="0"
                                step="0.01">
                        </div>
                    </div>
                    {% endif %}

                    {% if edit_mode %}
                    <div class="d-flex gap-2 justify-content-end">
                        <a href="{{ url_for('add_entry') }}" class="btn edit-entry-cancel">
                            <i class="bi bi-x-circle me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn edit-entry-update">
                            <i class="bi bi-check2-circle me-2"></i>Update Entry
                        </button>
                    </div>
                    {% else %}
                    <div class="save-entry-actions">
                        <button class="btn btn-success btn-lg w-100 py-3 shadow-soft save-entry-btn-desktop">Save Entry</button>
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>

        <!-- Recent Entries -->
        <div>
            <h5>Recent Entries</h5>

            {% if grouped_entries %}
            {% for date_group in grouped_entries %}
            <div class="mb-3">
                <div class="fw-semibold text-muted small mb-2">
                    {% if date_group.date == today %}
                    Today - {{ date_group.date[8:10] }}/{{ date_group.date[5:7] }}/{{ date_group.date[0:4] }}
                    {% else %}
                    {{ date_group.date[8:10] }}/{{ date_group.date[5:7] }}/{{ date_group.date[0:4] }}
                    {% endif %}
                </div>
                <div class="table-responsive recent-entries-wrap">
                    <table class="table table-sm align-middle recent-entries-table report-table mb-0">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Bank</th>
                                <th>Opening</th>
                                <th>Credited</th>
                                <th>Debited</th>
                                <th>Remaining</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for e in date_group.rows %}
                            <tr>
                                <td>
                                    <div class="text-muted small">{{ e.time[0:5] }}</div>
                                </td>
                                <td>{{ e.bank_name }}</td>
                                <td>{{ e.opening_balance }}</td>
                                <td class="text-success">{{ e.credited }}</td>
                                <td class="text-danger">{{ e.debited }}</td>
                                <td>{{ e.remaining_balance }}</td>
                                <td>
                                    {% if e.date == today %}
                                    <div class="d-flex gap-1 justify-content-center">
                                        <a href="{{ url_for('add_entry', edit_id=e._id) }}" class="btn btn-sm btn-action-icon px-2 py-1"
                                            title="Edit">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                                fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
                                                <path
                                                    d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z" />
                                                <path fill-rule="evenodd"
                                                    d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z" />
                                            </svg>
                                        </a>
                                        <form method="POST" action="/delete-entry/{{ e._id }}" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                            <button class="btn btn-sm btn-action-icon px-2 py-1" title="Delete"
                                                onclick="return confirm('Are you sure?');">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                                    fill="currentColor" class="bi bi-trash3" viewBox="0 0 16 16">
                                                    <path
                                                        d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11Zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5h9.916Zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47ZM8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z" />
                                                </svg>
                                            </button>
                                        </form>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">Locked</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-muted">No entries yet.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    setTimeout(function () {
        const alertBox = document.getElementById("errorAlert");
        if (alertBox) {
            alertBox.style.display = "none";
        }
    }, 3000);
</script>
<script>
    function selectBank(bankId, bankName) {
        const bankSelect = document.getElementById("bankSelect");
        if (!bankSelect) return;

        // Update hidden input
        bankSelect.value = bankId;

        // Update button text
        const btn = document.getElementById("bankDropdownBtn");
        if (btn) {
            btn.querySelector("span:first-child").textContent = bankName;
        }

        // Fetch balance
        fetchBalance();
    }

    function fetchBalance() {
        const bankSelect = document.getElementById("bankSelect");
        const dateInput = document.querySelector("input[name='entry_date']");
        const balanceField = document.getElementById("availableBalance");
        if (!balanceField || !bankSelect || !dateInput) {
            return;
        }

        const bankId = bankSelect.value;
        const entryDate = dateInput.value;

        if (!bankId || !entryDate) {
            balanceField.value = "0";
            return;
        }

        fetch(`/bank-balance/${bankId}/${entryDate}`)
            .then(res => res.json())
            .then(data => {
                balanceField.value = data.balance;
            })
            .catch(() => {
                balanceField.value = "0";
            });
    }

    // Auto-fetch balance if bank is pre-selected (e.g. after redirect)
    document.addEventListener("DOMContentLoaded", function () {
        const bankSelect = document.getElementById("bankSelect");
        if (bankSelect && bankSelect.value) {
            fetchBalance();
        }
    });
</script>
{% endblock %}
